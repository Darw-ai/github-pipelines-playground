name: AI Project Scaffolder

on:
  # Allow this workflow to be called from other repositories
  workflow_call:
    inputs:
      project_name:
        description: 'Name of the project/scaffold (used for branch naming)'
        required: true
        type: string
      task_issue_number:
        description: 'GitHub Issue number for status tracking (optional)'
        required: false
        type: string
      scaffold_prompt:
        description: 'Full prompt with product/security/compliance specs'
        required: true
        type: string
    secrets:
      AI_API_KEY:
        description: 'API key for AI provider (OpenAI, Anthropic, etc.)'
        required: false
      AI_MODEL:
        description: 'AI model identifier (e.g., anthropic/claude-3-5-sonnet-20241022)'
        required: false
      AI_ENDPOINT:
        description: 'Custom AI endpoint URL'
        required: false

  # Keep workflow_dispatch for testing in this repo
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Name of the project/scaffold (used for branch naming)'
        required: true
        type: string
      task_issue_number:
        description: 'GitHub Issue number for status tracking (optional)'
        required: false
        type: string
      scaffold_prompt:
        description: 'Full prompt with product/security/compliance specs'
        required: true
        type: string

# Least-privilege permissions
permissions:
  contents: write
  pull-requests: write
  issues: write

# Prevent concurrent scaffold runs
concurrency:
  group: scaffold-${{ github.event.inputs.project_name }}
  cancel-in-progress: false

jobs:
  # ========================================================
  # JOB 1: Generate Project Plan
  # ========================================================
  generate-plan:
    runs-on: ubuntu-latest
    outputs:
      plan_json: ${{ steps.create-plan.outputs.plan }}
      dependencies: ${{ steps.create-plan.outputs.dependencies }}

    steps:
      - name: Checkout target repository
        uses: actions/checkout@v4

      - name: Checkout SDLC platform scripts
        uses: actions/checkout@v4
        with:
          repository: Darw-ai/github-pipelines-playground
          path: .sdlc-platform
          sparse-checkout: |
            scripts

      - name: Update tracking issue - Start
        if: ${{ github.event.inputs.task_issue_number != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.task_issue_number }},
              body: 'ü§ñ **AI Scaffolding Initiated**\n\n**Project:** `${{ github.event.inputs.project_name }}`\n**Status:** Generating project plan...\n\n---\n*Started at: ' + new Date().toISOString() + '*'
            });

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install script dependencies
        run: |
          cd .sdlc-platform/scripts
          npm install

      - name: Generate project plan via AI
        id: create-plan
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_MODEL: ${{ secrets.AI_MODEL || 'bedrock/amazon.nova-pro-v1:0' }}
          AI_ENDPOINT: ${{ secrets.AI_ENDPOINT || 'https://bedrock-runtime.us-east-1.amazonaws.com' }}
          SCAFFOLD_PROMPT: ${{ github.event.inputs.scaffold_prompt }}
          PROJECT_NAME: ${{ github.event.inputs.project_name }}
        run: |
          cd .sdlc-platform/scripts
          node ai-generate-plan.js

          # Copy plan.json to repo root for artifact upload and later steps
          cp plan.json ../../plan.json

          # Read outputs
          PLAN=$(cat plan.json | jq -c '.files')
          DEPS=$(cat plan.json | jq -c '.dependencies')

          # Set outputs for next job
          echo "plan=${PLAN}" >> $GITHUB_OUTPUT
          echo "dependencies=${DEPS}" >> $GITHUB_OUTPUT

      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: scaffold-plan
          path: plan.json
          retention-days: 7

      - name: Update tracking issue - Plan generated
        if: success() && github.event.inputs.task_issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            const plan = require('./plan.json');
            const fileCount = plan.files.length;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.task_issue_number }},
              body: '‚úÖ **Project Plan Generated**\n\n' +
                    'üì¶ **Files to generate:** ' + fileCount + '\n' +
                    'üìù **Structure:**\n```\n' +
                    plan.files.map(f => f.path).join('\n') +
                    '\n```\n\n' +
                    '*Next: Generating code files...*'
            });

      - name: Update tracking issue - Plan failed
        if: failure() && github.event.inputs.task_issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.task_issue_number }},
              body: '‚ùå **Plan Generation Failed**\n\nCheck workflow logs for details.'
            });

  # ========================================================
  # JOB 2: Generate Code Files (Parallel Matrix)
  # ========================================================
  generate-code:
    needs: generate-plan
    runs-on: ubuntu-latest

    # Matrix strategy - one job per file
    strategy:
      matrix:
        file: ${{ fromJson(needs.generate-plan.outputs.plan_json) }}
      max-parallel: 3  # Balance parallelism with rate limits
      fail-fast: false  # Continue even if one file fails

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Checkout SDLC platform scripts
        uses: actions/checkout@v4
        with:
          repository: Darw-ai/github-pipelines-playground
          path: .sdlc-platform
          sparse-checkout: |
            scripts

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install script dependencies
        run: |
          cd .sdlc-platform/scripts
          npm install

      - name: Generate file content via AI
        env:
          AI_API_KEY: ${{ secrets.AI_API_KEY }}
          AI_MODEL: ${{ secrets.AI_MODEL || 'bedrock/amazon.nova-pro-v1:0' }}
          AI_ENDPOINT: ${{ secrets.AI_ENDPOINT }}
          FILE_PATH: ${{ matrix.file.path }}
          FILE_PROMPT: ${{ matrix.file.prompt }}
          PROJECT_NAME: ${{ github.event.inputs.project_name }}
        run: |
          cd .sdlc-platform/scripts
          node ai-generate-file.js

          # Debug: Check if file was created
          echo "=== Checking for generated-file.txt ==="
          ls -la generated-file.txt || echo "ERROR: generated-file.txt not found!"

          # Debug: Show where we are
          echo "=== Current directory ==="
          pwd

          # Create directory structure if needed
          TARGET_DIR="../../generated/$(dirname "$FILE_PATH")"
          echo "=== Creating directory: $TARGET_DIR ==="
          mkdir -p "$TARGET_DIR"

          # Move file
          echo "=== Moving file to: ../../generated/$FILE_PATH ==="
          mv generated-file.txt "../../generated/$FILE_PATH"

          # Verify the file was moved
          echo "=== Verifying file exists at destination ==="
          ls -la "../../generated/$FILE_PATH" || echo "ERROR: File not found at destination!"

      - name: Upload generated file
        uses: actions/upload-artifact@v4
        with:
          name: generated-file-${{ strategy.job-index }}
          path: generated
          retention-days: 7

      - name: Comment progress on issue
        if: success() && github.event.inputs.task_issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.task_issue_number }},
              body: 'üìù Generated: `${{ matrix.file.path }}`'
            });

  # ========================================================
  # JOB 3: Commit Scaffold & Create PR
  # ========================================================
  commit-scaffold:
    needs: [generate-plan, generate-code]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for branching

      - name: Download all generated files
        uses: actions/download-artifact@v4
        with:
          pattern: generated-file-*
          path: generated
          merge-multiple: true

      - name: Download plan artifact
        uses: actions/download-artifact@v4
        with:
          name: scaffold-plan
          path: .

      - name: Setup Git
        run: |
          git config user.name "AI Scaffolder"
          git config user.email "ai-scaffolder@github-actions"

      - name: Create scaffold branch
        run: |
          BRANCH_NAME="ai-scaffold/${{ github.event.inputs.project_name }}-${{ github.run_id }}"
          git checkout -b "$BRANCH_NAME"

      - name: Debug - List downloaded artifacts
        run: |
          echo "=== Current directory contents ==="
          ls -la
          echo ""
          echo "=== All files in current directory (recursive) ==="
          find . -type f -name "*.ts" -o -name "*.json" -o -name "*.js" -o -name "*.md" || true
          echo ""
          echo "=== Contents of generated directory (if exists) ==="
          ls -laR generated 2>/dev/null || echo "generated directory not found"
          echo ""
          echo "=== Total files found in generated/ ==="
          find generated -type f 2>/dev/null | wc -l || echo "0"
          echo ""
          echo "=== Searching for ANY generated files ==="
          find . -type f -path "*/generated/*" 2>/dev/null || echo "No files in generated paths found"

      - name: Move generated files to root
        run: |
          # Check if directory exists and has files
          if [ -d "generated" ] && [ "$(find generated -type f 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "Moving $(find generated -type f | wc -l) files..."
            # Move all files from generated/ to root, preserving directory structure
            find generated -type f -exec sh -c '
              TARGET="${1#generated/}"
              mkdir -p "$(dirname "$TARGET")"
              mv "$1" "$TARGET"
            ' sh {} \;
            rm -rf generated
            echo "‚úÖ Files moved successfully"
          else
            echo "‚ö†Ô∏è  No files found in generated directory"
            exit 1
          fi

      - name: Create dependencies file (if applicable)
        run: |
          if [ -f plan.json ]; then
            DEPS=$(cat plan.json | jq -r '.dependencies // empty')
            if [ ! -z "$DEPS" ]; then
              echo "$DEPS" > package.json
            fi
          fi

      - name: Commit scaffold
        run: |
          git add .
          git commit -m "feat: AI-generated scaffold for ${{ github.event.inputs.project_name }} (issue #${{ github.event.inputs.task_issue_number }})"

      - name: Push scaffold branch
        run: |
          BRANCH_NAME="ai-scaffold/${{ github.event.inputs.project_name }}-${{ github.run_id }}"
          echo "Pushing branch: $BRANCH_NAME"

          # Delete remote branch if it exists (handles re-runs with same run_id)
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è  Branch already exists on remote, deleting it first..."
            git push origin --delete "$BRANCH_NAME" || true
          fi

          # Push the new branch
          git push -u origin "$BRANCH_NAME"

          # Verify the push succeeded
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME"; then
            echo "‚úÖ Branch successfully pushed to remote"
          else
            echo "‚ùå ERROR: Branch push failed or branch not found on remote"
            exit 1
          fi

      - name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = `ai-scaffold/${{ github.event.inputs.project_name }}-${{ github.run_id }}`;
            const issueNumber = '${{ github.event.inputs.task_issue_number }}';
            const workflowUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';

            // Build PR body
            let prBody = `## AI-Generated Project Scaffold\n\n`;
            prBody += `**Project Name:** ${{ github.event.inputs.project_name }}\n`;
            if (issueNumber) {
              prBody += `**Tracking Issue:** #${issueNumber}\n`;
            }
            prBody += `\n---\n\n`;
            prBody += `### Generated Files\n\n`;
            prBody += `This PR contains a complete project structure generated by AI.\n\n`;
            prBody += `**Important:** Please review all files before merging:\n`;
            prBody += `- [ ] Verify code quality and best practices\n`;
            prBody += `- [ ] Check for security issues\n`;
            prBody += `- [ ] Validate dependencies\n`;
            prBody += `- [ ] Run tests (if applicable)\n\n`;
            prBody += `---\n\n`;
            prBody += `*Generated by workflow: ${workflowUrl}*`;

            // Create the PR
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `feat: AI-Generated Project Scaffold - ${{ github.event.inputs.project_name }}`,
              head: branchName,
              base: 'main',
              body: prBody
            });

            // Try to add labels (ignore if labels don't exist)
            try {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.data.number,
                labels: ['ai-generated', 'scaffold']
              });
            } catch (error) {
              console.log('Note: Could not add labels (they may not exist)');
            }

            // Set outputs
            core.setOutput('pull-request-number', pr.data.number);
            core.setOutput('pull-request-url', pr.data.html_url);

            console.log(`‚úÖ Pull request created: ${pr.data.html_url}`);

      - name: Update tracking issue - Success
        if: success() && github.event.inputs.task_issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.task_issue_number }},
              body: '‚úÖ **Scaffolding Complete!**\n\n' +
                    'üîó **Pull Request:** #${{ steps.create-pr.outputs.pull-request-number }}\n' +
                    'üìä **Review:** ${{ steps.create-pr.outputs.pull-request-url }}\n\n' +
                    '**Next Steps:**\n' +
                    '1. Review the generated code\n' +
                    '2. Run any necessary tests\n' +
                    '3. Merge the PR when ready\n\n' +
                    '*This issue will be automatically closed.*'
            });

            // Close the tracking issue
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.task_issue_number }},
              state: 'closed',
              labels: ['completed', 'ai-scaffold']
            });

      - name: Update tracking issue - Failure
        if: failure() && github.event.inputs.task_issue_number != ''
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.task_issue_number }},
              body: '‚ùå **Scaffold Commit Failed**\n\n' +
                    'Failed to commit the generated files or create PR.\n\n' +
                    '**Logs:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})'
            });

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.inputs.task_issue_number }},
              labels: ['failed']
            });
